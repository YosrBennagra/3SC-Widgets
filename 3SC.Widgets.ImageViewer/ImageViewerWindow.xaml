<local:WidgetWindowBase x:Class="_3SC.Widgets.ImageViewer.ImageViewerWindow"
                        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                        xmlns:local="clr-namespace:_3SC.Widgets.ImageViewer"
                        Title="Image"
                        Width="400"
                        Height="300"
                        WindowStyle="None"
                        AllowsTransparency="True"
                        Background="Transparent"
                        ShowInTaskbar="False"
                        Topmost="False"
                        ResizeMode="NoResize">

    <local:WidgetWindowBase.Resources>
        <!-- 3SC Dark Theme Colors -->
        <SolidColorBrush x:Key="WidgetSurface"
                         Color="#D0080810"/>
        <SolidColorBrush x:Key="WidgetText"
                         Color="#FFF1F5F9"/>
        <SolidColorBrush x:Key="Accent"
                         Color="#FF2DD4BF"/>
        <SolidColorBrush x:Key="SurfaceElevated"
                         Color="#FF16161F"/>
        <SolidColorBrush x:Key="Border"
                         Color="#FF2A2A3A"/>
        <SolidColorBrush x:Key="SurfaceHover"
                         Color="#FF1C1C28"/>
        <SolidColorBrush x:Key="TextPrimary"
                         Color="#FFF1F5F9"/>
        <SolidColorBrush x:Key="TextSecondary"
                         Color="#FF94A3B8"/>
        <SolidColorBrush x:Key="TextTertiary"
                         Color="#FF64748B"/>
        <SolidColorBrush x:Key="CardBackground"
                         Color="#FF101018"/>
        <SolidColorBrush x:Key="CardBorder"
                         Color="#FF2A2A3A"/>
        <SolidColorBrush x:Key="WidgetBackground"
                         Color="#FF0A0A0F"/>
        <SolidColorBrush x:Key="WidgetOutline"
                         Color="#FF2DD4BF"/>

        <!-- Converters -->
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <local:InvertedBooleanToVisibilityConverter x:Key="InvertedBooleanToVisibilityConverter"/>

        <!-- Context Menu Style -->
        <Style TargetType="ContextMenu">
            <Setter Property="Background"
                    Value="#FF16161F"/>
            <Setter Property="BorderBrush"
                    Value="#FF2A2A3A"/>
            <Setter Property="BorderThickness"
                    Value="1"/>
            <Setter Property="Padding"
                    Value="6"/>
            <Setter Property="SnapsToDevicePixels"
                    Value="True"/>
            <Setter Property="HasDropShadow"
                    Value="True"/>
            <Setter Property="FontSize"
                    Value="13"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ContextMenu">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="10"
                                Padding="{TemplateBinding Padding}">
                            <Border.Effect>
                                <DropShadowEffect BlurRadius="32"
                                                  ShadowDepth="8"
                                                  Opacity="0.4"
                                                  Color="#000000"/>
                            </Border.Effect>
                            <StackPanel IsItemsHost="True"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- MenuItem Style -->
        <Style TargetType="MenuItem">
            <Setter Property="Background"
                    Value="Transparent"/>
            <Setter Property="Foreground"
                    Value="#FFF1F5F9"/>
            <Setter Property="Padding"
                    Value="12,10"/>
            <Setter Property="MinHeight"
                    Value="36"/>
            <Setter Property="FontSize"
                    Value="13"/>
            <Setter Property="Cursor"
                    Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="MenuItem">
                        <Border x:Name="Border"
                                Background="{TemplateBinding Background}"
                                BorderThickness="0"
                                CornerRadius="6"
                                Margin="2"
                                SnapsToDevicePixels="True">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"
                                                      MinWidth="24"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <ContentPresenter Grid.Column="0"
                                                  ContentSource="Icon"
                                                  Margin="8,0,8,0"
                                                  VerticalAlignment="Center"/>
                                <ContentPresenter Grid.Column="1"
                                                  ContentSource="Header"
                                                  Margin="{TemplateBinding Padding}"
                                                  VerticalAlignment="Center"
                                                  RecognizesAccessKey="True"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsHighlighted"
                                     Value="True">
                                <Setter TargetName="Border"
                                        Property="Background"
                                        Value="#FF1C1C28"/>
                            </Trigger>
                            <Trigger Property="IsEnabled"
                                     Value="False">
                                <Setter Property="Opacity"
                                        Value="0.4"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Separator Style -->
        <Style TargetType="Separator">
            <Setter Property="Background"
                    Value="#FF2A2A3A"/>
            <Setter Property="Height"
                    Value="1"/>
            <Setter Property="Margin"
                    Value="8,6"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Separator">
                        <Border Background="{TemplateBinding Background}"
                                Height="{TemplateBinding Height}"
                                Margin="{TemplateBinding Margin}"
                                Opacity="0.4"/>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Modern ScrollBar Style -->
        <Style TargetType="ScrollBar">
            <Setter Property="Background"
                    Value="Transparent"/>
            <Setter Property="BorderThickness"
                    Value="0"/>
            <Setter Property="MinWidth"
                    Value="8"/>
            <Setter Property="MinHeight"
                    Value="8"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ScrollBar">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <Border Background="{TemplateBinding Background}"
                                    CornerRadius="4"
                                    Opacity="0.3"/>
                            <Track x:Name="PART_Track"
                                   IsDirectionReversed="True">
                                <Track.Thumb>
                                    <Thumb>
                                        <Thumb.Template>
                                            <ControlTemplate TargetType="Thumb">
                                                <Border x:Name="ThumbBorder"
                                                        Background="{StaticResource TextTertiary}"
                                                        CornerRadius="4"
                                                        Opacity="0.4"
                                                        Margin="2">
                                                    <Border.RenderTransform>
                                                        <ScaleTransform ScaleX="1"
                                                                        ScaleY="1"/>
                                                    </Border.RenderTransform>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver"
                                                             Value="True">
                                                        <Setter TargetName="ThumbBorder"
                                                                Property="Background"
                                                                Value="{StaticResource Accent}"/>
                                                        <Setter TargetName="ThumbBorder"
                                                                Property="Opacity"
                                                                Value="0.8"/>
                                                    </Trigger>
                                                    <Trigger Property="IsDragging"
                                                             Value="True">
                                                        <Setter TargetName="ThumbBorder"
                                                                Property="Background"
                                                                Value="{StaticResource Accent}"/>
                                                        <Setter TargetName="ThumbBorder"
                                                                Property="Opacity"
                                                                Value="1"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Thumb.Template>
                                    </Thumb>
                                </Track.Thumb>
                            </Track>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="Orientation"
                                     Value="Horizontal">
                                <Setter TargetName="PART_Track"
                                        Property="IsDirectionReversed"
                                        Value="False"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="Orientation"
                         Value="Horizontal">
                    <Setter Property="MinHeight"
                            Value="8"/>
                    <Setter Property="Height"
                            Value="8"/>
                    <Setter Property="MinWidth"
                            Value="0"/>
                </Trigger>
                <Trigger Property="Orientation"
                         Value="Vertical">
                    <Setter Property="MinWidth"
                            Value="8"/>
                    <Setter Property="Width"
                            Value="8"/>
                    <Setter Property="MinHeight"
                            Value="0"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </local:WidgetWindowBase.Resources>
    <Grid Margin="6">
        <Border x:Name="RootBorder"
                Background="{StaticResource WidgetSurface}"
                CornerRadius="18"
                PreviewMouseLeftButtonDown="Border_PreviewMouseLeftButtonDown"
                PreviewMouseMove="Border_PreviewMouseMove"
                PreviewMouseLeftButtonUp="Border_PreviewMouseLeftButtonUp">

            <Border.ContextMenu>
                <ContextMenu>
                    <MenuItem x:Name="LockWidgetMenuItem"
                              Header="Lock Widget"
                              Click="LockWidget_Click"
                              IsCheckable="True"/>
                    <MenuItem x:Name="ResizeToggleMenuItem"
                              Header="Resize Handles"
                              Click="ResizeToggle_Click"
                              IsCheckable="True"/>
                    <Separator/>
                    <MenuItem Header="Remove Widget"
                              Click="RemoveWidget_Click"/>
                </ContextMenu>
            </Border.ContextMenu>

            <Grid>
                <!-- Resize outline -->
                <Rectangle x:Name="ResizeOutline"
                           Stroke="{StaticResource WidgetOutline}"
                           StrokeThickness="2"
                           RadiusX="18"
                           RadiusY="18"
                           Visibility="Collapsed"/>

                <!-- Resize handles -->
                <Thumb x:Name="ResizeTop"
                       Width="14"
                       Height="14"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Top"
                       Cursor="SizeNS"
                       DragDelta="ResizeTop_DragDelta"
                       Visibility="Collapsed"
                       Margin="0,-7,0,0"
                       Panel.ZIndex="10">
                    <Thumb.Template>
                        <ControlTemplate TargetType="Thumb">
                            <Border Background="{StaticResource WidgetOutline}"
                                    CornerRadius="7"/>
                        </ControlTemplate>
                    </Thumb.Template>
                </Thumb>

                <Thumb x:Name="ResizeBottom"
                       Width="14"
                       Height="14"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Bottom"
                       Cursor="SizeNS"
                       DragDelta="ResizeBottom_DragDelta"
                       Visibility="Collapsed"
                       Margin="0,0,0,-7"
                       Panel.ZIndex="10">
                    <Thumb.Template>
                        <ControlTemplate TargetType="Thumb">
                            <Border Background="{StaticResource WidgetOutline}"
                                    CornerRadius="7"/>
                        </ControlTemplate>
                    </Thumb.Template>
                </Thumb>

                <Thumb x:Name="ResizeLeft"
                       Width="14"
                       Height="14"
                       HorizontalAlignment="Left"
                       VerticalAlignment="Center"
                       Cursor="SizeWE"
                       DragDelta="ResizeLeft_DragDelta"
                       Visibility="Collapsed"
                       Margin="-7,0,0,0"
                       Panel.ZIndex="10">
                    <Thumb.Template>
                        <ControlTemplate TargetType="Thumb">
                            <Border Background="{StaticResource WidgetOutline}"
                                    CornerRadius="7"/>
                        </ControlTemplate>
                    </Thumb.Template>
                </Thumb>

                <Thumb x:Name="ResizeRight"
                       Width="14"
                       Height="14"
                       HorizontalAlignment="Right"
                       VerticalAlignment="Center"
                       Cursor="SizeWE"
                       DragDelta="ResizeRight_DragDelta"
                       Visibility="Collapsed"
                       Margin="0,0,-7,0"
                       Panel.ZIndex="10">
                    <Thumb.Template>
                        <ControlTemplate TargetType="Thumb">
                            <Border Background="{StaticResource WidgetOutline}"
                                    CornerRadius="7"/>
                        </ControlTemplate>
                    </Thumb.Template>
                </Thumb>

                <Grid Margin="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="170"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Left Panel: File List -->
                    <Border Grid.Column="0"
                            Background="{StaticResource CardBackground}"
                            BorderBrush="{StaticResource CardBorder}"
                            BorderThickness="0,0,1,0">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <!-- Header -->
                            <Border Grid.Row="0"
                                    Padding="10,8">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Text="Images"
                                               FontSize="13"
                                               FontWeight="SemiBold"
                                               Foreground="{StaticResource TextPrimary}"
                                               VerticalAlignment="Center"/>

                                    <Button Grid.Column="1"
                                            Command="{Binding RefreshCommand}"
                                            ToolTip="Refresh"
                                            Cursor="Hand"
                                            Opacity="0.7">
                                        <Button.Template>
                                            <ControlTemplate TargetType="Button">
                                                <Border x:Name="bg"
                                                        Padding="4"
                                                        CornerRadius="4"
                                                        Background="Transparent">
                                                    <TextBlock Text="&#xE72C;"
                                                               FontFamily="Segoe MDL2 Assets"
                                                               FontSize="12"
                                                               Foreground="{StaticResource TextSecondary}"/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver"
                                                             Value="True">
                                                        <Setter TargetName="bg"
                                                                Property="Background"
                                                                Value="{StaticResource CardBackground}"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Button.Template>
                                    </Button>
                                </Grid>
                            </Border>

                            <!-- Search box -->
                            <Border Grid.Row="1"
                                    Margin="8,0,8,8"
                                    Padding="8,6"
                                    CornerRadius="6"
                                    Background="{StaticResource WidgetBackground}"
                                    BorderBrush="{StaticResource CardBorder}"
                                    BorderThickness="1">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Text="&#xE721;"
                                               FontFamily="Segoe MDL2 Assets"
                                               FontSize="12"
                                               Foreground="{StaticResource TextTertiary}"
                                               VerticalAlignment="Center"
                                               Margin="0,0,6,0"/>

                                    <TextBox Grid.Column="1"
                                             Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                                             FontSize="12"
                                             Foreground="{StaticResource TextPrimary}"
                                             Background="Transparent"
                                             BorderThickness="0"
                                             VerticalAlignment="Center"
                                             CaretBrush="{StaticResource Accent}"/>

                                    <TextBlock Grid.Column="1"
                                               Text="Search..."
                                               FontSize="12"
                                               Foreground="{StaticResource TextTertiary}"
                                               VerticalAlignment="Center"
                                               IsHitTestVisible="False">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility"
                                                        Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding SearchText}"
                                                                 Value="">
                                                        <Setter Property="Visibility"
                                                                Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </Grid>
                            </Border>

                            <!-- File list -->
                            <ScrollViewer Grid.Row="2"
                                          VerticalScrollBarVisibility="Auto"
                                          HorizontalScrollBarVisibility="Disabled">
                                <StackPanel>
                                    <!-- Loading indicator -->
                                    <StackPanel Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                HorizontalAlignment="Center"
                                                Margin="0,20">
                                        <TextBlock Text="&#xE117;"
                                                   FontFamily="Segoe MDL2 Assets"
                                                   FontSize="16"
                                                   Foreground="{StaticResource TextTertiary}"
                                                   HorizontalAlignment="Center">
                                            <TextBlock.RenderTransform>
                                                <RotateTransform CenterX="8"
                                                                 CenterY="8"/>
                                            </TextBlock.RenderTransform>
                                            <TextBlock.Triggers>
                                                <EventTrigger RoutedEvent="Loaded">
                                                    <BeginStoryboard>
                                                        <Storyboard RepeatBehavior="Forever">
                                                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(RotateTransform.Angle)"
                                                                             From="0"
                                                                             To="360"
                                                                             Duration="0:0:1"/>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </EventTrigger>
                                            </TextBlock.Triggers>
                                        </TextBlock>
                                        <TextBlock Text="Scanning..."
                                                   FontSize="11"
                                                   Foreground="{StaticResource TextTertiary}"
                                                   HorizontalAlignment="Center"
                                                   Margin="0,4,0,0"/>
                                    </StackPanel>

                                    <!-- Recent files section -->
                                    <StackPanel Visibility="{Binding HasRecentFiles, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                Margin="8,4,8,0">
                                        <TextBlock Text="RECENT"
                                                   FontSize="10"
                                                   FontWeight="SemiBold"
                                                   Foreground="{StaticResource TextTertiary}"
                                                   Margin="4,0,0,4"/>

                                        <ItemsControl ItemsSource="{Binding RecentFiles}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Button Command="{Binding DataContext.SelectFileCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                            CommandParameter="{Binding}"
                                                            Cursor="Hand"
                                                            Margin="0,1">
                                                        <Button.Template>
                                                            <ControlTemplate TargetType="Button">
                                                                <Border x:Name="bg"
                                                                        Padding="6,5"
                                                                        CornerRadius="4"
                                                                        Background="Transparent">
                                                                    <Grid>
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="Auto"/>
                                                                            <ColumnDefinition Width="*"/>
                                                                        </Grid.ColumnDefinitions>

                                                                        <Border Width="28"
                                                                                Height="28"
                                                                                CornerRadius="4"
                                                                                Background="#203498DB"
                                                                                Margin="0,0,8,0">
                                                                            <TextBlock Text="&#xE91B;"
                                                                                       FontFamily="Segoe MDL2 Assets"
                                                                                       FontSize="12"
                                                                                       Foreground="#3498DB"
                                                                                       HorizontalAlignment="Center"
                                                                                       VerticalAlignment="Center"/>
                                                                        </Border>

                                                                        <StackPanel Grid.Column="1"
                                                                                    VerticalAlignment="Center">
                                                                            <TextBlock Text="{Binding FileName}"
                                                                                       FontSize="11"
                                                                                       Foreground="{StaticResource TextPrimary}"
                                                                                       TextTrimming="CharacterEllipsis"
                                                                                       MaxWidth="110"/>
                                                                            <TextBlock Text="{Binding FileSize}"
                                                                                       FontSize="9"
                                                                                       Foreground="{StaticResource TextTertiary}"/>
                                                                        </StackPanel>
                                                                    </Grid>
                                                                </Border>
                                                                <ControlTemplate.Triggers>
                                                                    <DataTrigger Binding="{Binding IsSelected}"
                                                                                 Value="True">
                                                                        <Setter TargetName="bg"
                                                                                Property="Background"
                                                                                Value="{StaticResource Accent}"/>
                                                                    </DataTrigger>
                                                                    <Trigger Property="IsMouseOver"
                                                                             Value="True">
                                                                        <Setter TargetName="bg"
                                                                                Property="Background"
                                                                                Value="{StaticResource CardBackground}"/>
                                                                    </Trigger>
                                                                </ControlTemplate.Triggers>
                                                            </ControlTemplate>
                                                        </Button.Template>
                                                    </Button>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>

                                        <Border Height="1"
                                                Margin="4,8"
                                                Background="{StaticResource CardBorder}"
                                                Opacity="0.3"/>
                                    </StackPanel>

                                    <!-- All files section -->
                                    <StackPanel Margin="8,0,8,8">
                                        <TextBlock Text="FROM PICTURES &amp; DOWNLOADS"
                                                   FontSize="10"
                                                   FontWeight="SemiBold"
                                                   Foreground="{StaticResource TextTertiary}"
                                                   Margin="4,0,0,4"
                                                   Visibility="{Binding HasFiles, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                                        <ItemsControl ItemsSource="{Binding ImageFiles}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Button Command="{Binding DataContext.SelectFileCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                            CommandParameter="{Binding}"
                                                            Cursor="Hand"
                                                            Margin="0,1">
                                                        <Button.Template>
                                                            <ControlTemplate TargetType="Button">
                                                                <Border x:Name="bg"
                                                                        Padding="6,5"
                                                                        CornerRadius="4"
                                                                        Background="Transparent">
                                                                    <Grid>
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="Auto"/>
                                                                            <ColumnDefinition Width="*"/>
                                                                        </Grid.ColumnDefinitions>

                                                                        <Border Width="28"
                                                                                Height="28"
                                                                                CornerRadius="4"
                                                                                Background="#203498DB"
                                                                                Margin="0,0,8,0">
                                                                            <TextBlock Text="&#xE91B;"
                                                                                       FontFamily="Segoe MDL2 Assets"
                                                                                       FontSize="12"
                                                                                       Foreground="#3498DB"
                                                                                       HorizontalAlignment="Center"
                                                                                       VerticalAlignment="Center"/>
                                                                        </Border>

                                                                        <StackPanel Grid.Column="1"
                                                                                    VerticalAlignment="Center">
                                                                            <TextBlock Text="{Binding FileName}"
                                                                                       FontSize="11"
                                                                                       Foreground="{StaticResource TextPrimary}"
                                                                                       TextTrimming="CharacterEllipsis"
                                                                                       MaxWidth="110"/>
                                                                            <StackPanel Orientation="Horizontal">
                                                                                <TextBlock Text="{Binding FileSize}"
                                                                                           FontSize="9"
                                                                                           Foreground="{StaticResource TextTertiary}"/>
                                                                                <TextBlock Text=" • "
                                                                                           FontSize="9"
                                                                                           Foreground="{StaticResource TextTertiary}"/>
                                                                                <TextBlock Text="{Binding LastModifiedText}"
                                                                                           FontSize="9"
                                                                                           Foreground="{StaticResource TextTertiary}"/>
                                                                            </StackPanel>
                                                                        </StackPanel>
                                                                    </Grid>
                                                                </Border>
                                                                <ControlTemplate.Triggers>
                                                                    <DataTrigger Binding="{Binding IsSelected}"
                                                                                 Value="True">
                                                                        <Setter TargetName="bg"
                                                                                Property="Background"
                                                                                Value="{StaticResource Accent}"/>
                                                                    </DataTrigger>
                                                                    <Trigger Property="IsMouseOver"
                                                                             Value="True">
                                                                        <Setter TargetName="bg"
                                                                                Property="Background"
                                                                                Value="{StaticResource CardBackground}"/>
                                                                    </Trigger>
                                                                </ControlTemplate.Triggers>
                                                            </ControlTemplate>
                                                        </Button.Template>
                                                    </Button>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>

                                        <StackPanel Visibility="{Binding HasFiles, Converter={StaticResource InvertedBooleanToVisibilityConverter}}"
                                                    HorizontalAlignment="Center"
                                                    Margin="0,20">
                                            <TextBlock Text="No images found"
                                                       FontSize="11"
                                                       Foreground="{StaticResource TextTertiary}"
                                                       HorizontalAlignment="Center"/>
                                        </StackPanel>
                                    </StackPanel>

                                    <!-- Browse button -->
                                    <Border Margin="8,4,8,12">
                                        <Button Command="{Binding BrowseImageCommand}"
                                                Cursor="Hand">
                                            <Button.Template>
                                                <ControlTemplate TargetType="Button">
                                                    <Border x:Name="bg"
                                                            Padding="10,8"
                                                            CornerRadius="6"
                                                            Background="{StaticResource WidgetBackground}"
                                                            BorderBrush="{StaticResource CardBorder}"
                                                            BorderThickness="1">
                                                        <StackPanel Orientation="Horizontal"
                                                                    HorizontalAlignment="Center">
                                                            <TextBlock Text="&#xE8E5;"
                                                                       FontFamily="Segoe MDL2 Assets"
                                                                       FontSize="12"
                                                                       Foreground="{StaticResource TextSecondary}"
                                                                       VerticalAlignment="Center"
                                                                       Margin="0,0,6,0"/>
                                                            <TextBlock Text="Browse..."
                                                                       FontSize="11"
                                                                       Foreground="{StaticResource TextSecondary}"/>
                                                        </StackPanel>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver"
                                                                 Value="True">
                                                            <Setter TargetName="bg"
                                                                    Property="Background"
                                                                    Value="{StaticResource Accent}"/>
                                                            <Setter TargetName="bg"
                                                                    Property="BorderBrush"
                                                                    Value="{StaticResource Accent}"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Button.Template>
                                        </Button>
                                    </Border>
                                </StackPanel>
                            </ScrollViewer>
                        </Grid>
                    </Border>

                    <!-- Right Panel: Image Preview -->
                    <Grid Grid.Column="1">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Header -->
                        <Border Grid.Row="0"
                                Padding="12,8"
                                Background="Transparent">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <StackPanel VerticalAlignment="Center"
                                            Visibility="{Binding HasImage, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <TextBlock Text="{Binding FileName}"
                                               FontSize="12"
                                               FontWeight="Medium"
                                               Foreground="{StaticResource TextPrimary}"
                                               TextTrimming="CharacterEllipsis"/>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{Binding Dimensions}"
                                                   FontSize="10"
                                                   Foreground="{StaticResource TextTertiary}"/>
                                        <TextBlock Text=" • "
                                                   FontSize="10"
                                                   Foreground="{StaticResource TextTertiary}"/>
                                        <TextBlock Text="{Binding FileInfo}"
                                                   FontSize="10"
                                                   Foreground="{StaticResource TextTertiary}"/>
                                    </StackPanel>
                                </StackPanel>

                                <TextBlock Grid.Column="0"
                                           Text="Preview"
                                           FontSize="12"
                                           FontWeight="Medium"
                                           Foreground="{StaticResource TextSecondary}"
                                           VerticalAlignment="Center"
                                           Visibility="{Binding HasImage, Converter={StaticResource InvertedBooleanToVisibilityConverter}}"/>

                                <!-- Action buttons -->
                                <StackPanel Grid.Column="1"
                                            Orientation="Horizontal"
                                            Visibility="{Binding HasImage, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <Button Command="{Binding SetAsWallpaperCommand}"
                                            ToolTip="Set as wallpaper"
                                            Cursor="Hand"
                                            Margin="0,0,4,0">
                                        <Button.Template>
                                            <ControlTemplate TargetType="Button">
                                                <Border x:Name="bg"
                                                        Padding="6,4"
                                                        CornerRadius="4"
                                                        Background="Transparent">
                                                    <TextBlock Text="&#xE91B;"
                                                               FontFamily="Segoe MDL2 Assets"
                                                               FontSize="12"
                                                               Foreground="{StaticResource TextSecondary}"/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver"
                                                             Value="True">
                                                        <Setter TargetName="bg"
                                                                Property="Background"
                                                                Value="{StaticResource CardBackground}"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Button.Template>
                                    </Button>
                                    <Button Command="{Binding OpenInDefaultAppCommand}"
                                            ToolTip="Open in viewer"
                                            Cursor="Hand"
                                            Margin="0,0,4,0">
                                        <Button.Template>
                                            <ControlTemplate TargetType="Button">
                                                <Border x:Name="bg"
                                                        Padding="6,4"
                                                        CornerRadius="4"
                                                        Background="Transparent">
                                                    <TextBlock Text="&#xE8A7;"
                                                               FontFamily="Segoe MDL2 Assets"
                                                               FontSize="12"
                                                               Foreground="{StaticResource TextSecondary}"/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver"
                                                             Value="True">
                                                        <Setter TargetName="bg"
                                                                Property="Background"
                                                                Value="{StaticResource CardBackground}"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Button.Template>
                                    </Button>
                                    <Button Command="{Binding OpenInExplorerCommand}"
                                            ToolTip="Show in Explorer"
                                            Cursor="Hand">
                                        <Button.Template>
                                            <ControlTemplate TargetType="Button">
                                                <Border x:Name="bg"
                                                        Padding="6,4"
                                                        CornerRadius="4"
                                                        Background="Transparent">
                                                    <TextBlock Text="&#xEC50;"
                                                               FontFamily="Segoe MDL2 Assets"
                                                               FontSize="12"
                                                               Foreground="{StaticResource TextSecondary}"/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver"
                                                             Value="True">
                                                        <Setter TargetName="bg"
                                                                Property="Background"
                                                                Value="{StaticResource CardBackground}"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Button.Template>
                                    </Button>
                                </StackPanel>
                            </Grid>
                        </Border>

                        <Border Grid.Row="0"
                                VerticalAlignment="Bottom"
                                Height="1"
                                Margin="8,0"
                                Background="{StaticResource CardBorder}"
                                Opacity="0.25"/>

                        <!-- Image preview area -->
                        <Grid Grid.Row="1"
                              Margin="8"
                              local:DropFileBehavior.DropHandler="{Binding DropHandler}">
                            <!-- Empty state -->
                            <Border Visibility="{Binding HasImage, Converter={StaticResource InvertedBooleanToVisibilityConverter}}"
                                    CornerRadius="12"
                                    Background="{StaticResource CardBackground}"
                                    BorderThickness="2"
                                    Opacity="0.8">
                                <Border.BorderBrush>
                                    <VisualBrush Viewport="0,0,8,8"
                                                 ViewportUnits="Absolute"
                                                 TileMode="Tile">
                                        <VisualBrush.Visual>
                                            <Rectangle Width="8"
                                                       Height="8"
                                                       StrokeThickness="1"
                                                       Stroke="{StaticResource CardBorder}"
                                                       StrokeDashArray="2,2"/>
                                        </VisualBrush.Visual>
                                    </VisualBrush>
                                </Border.BorderBrush>

                                <StackPanel HorizontalAlignment="Center"
                                            VerticalAlignment="Center">
                                    <Border Width="64"
                                            Height="64"
                                            CornerRadius="12"
                                            Background="#153498DB"
                                            Margin="0,0,0,12">
                                        <TextBlock Text="&#xE91B;"
                                                   FontFamily="Segoe MDL2 Assets"
                                                   FontSize="28"
                                                   Foreground="#3498DB"
                                                   HorizontalAlignment="Center"
                                                   VerticalAlignment="Center"/>
                                    </Border>
                                    <TextBlock Text="Drop image here"
                                               FontSize="13"
                                               FontWeight="Medium"
                                               Foreground="{StaticResource TextSecondary}"
                                               HorizontalAlignment="Center"/>
                                    <TextBlock Text="or select from the list"
                                               FontSize="11"
                                               Foreground="{StaticResource TextTertiary}"
                                               HorizontalAlignment="Center"
                                               Margin="0,4,0,0"/>
                                </StackPanel>
                            </Border>

                            <!-- Image display -->
                            <Border Visibility="{Binding HasImage, Converter={StaticResource BooleanToVisibilityConverter}}"
                                    CornerRadius="8"
                                    Background="{StaticResource CardBackground}"
                                    ClipToBounds="True">
                                <ScrollViewer x:Name="PreviewScroller"
                                              HorizontalScrollBarVisibility="Auto"
                                              VerticalScrollBarVisibility="Auto"
                                              PanningMode="Both">
                                    <Grid>
                                        <Image Source="{Binding CurrentImage}"
                                               Stretch="Uniform"
                                               StretchDirection="DownOnly"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"
                                               MaxWidth="{Binding ActualWidth, ElementName=PreviewScroller}"
                                               MaxHeight="{Binding ActualHeight, ElementName=PreviewScroller}"
                                               RenderOptions.BitmapScalingMode="HighQuality">
                                            <Image.LayoutTransform>
                                                <ScaleTransform ScaleX="{Binding ZoomLevel}"
                                                                ScaleY="{Binding ZoomLevel}"/>
                                            </Image.LayoutTransform>
                                        </Image>
                                    </Grid>
                                </ScrollViewer>
                            </Border>
                        </Grid>

                        <!-- Footer with zoom controls -->
                        <Border Grid.Row="2"
                                Padding="10,6"
                                Visibility="{Binding HasImage, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <StackPanel Orientation="Horizontal"
                                        HorizontalAlignment="Center">
                                <Button Command="{Binding ZoomOutCommand}"
                                        ToolTip="Zoom out"
                                        Cursor="Hand">
                                    <Button.Template>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="bg"
                                                    Width="28"
                                                    Height="28"
                                                    CornerRadius="4"
                                                    Background="Transparent">
                                                <TextBlock Text="&#xE71F;"
                                                           FontFamily="Segoe MDL2 Assets"
                                                           FontSize="12"
                                                           Foreground="{StaticResource TextTertiary}"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver"
                                                         Value="True">
                                                    <Setter TargetName="bg"
                                                            Property="Background"
                                                            Value="{StaticResource CardBackground}"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Button.Template>
                                </Button>

                                <Button Command="{Binding ResetZoomCommand}"
                                        ToolTip="Reset zoom"
                                        Cursor="Hand"
                                        Margin="4,0">
                                    <Button.Template>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="bg"
                                                    Padding="8,4"
                                                    CornerRadius="4"
                                                    Background="Transparent">
                                                <TextBlock Text="{Binding ZoomText}"
                                                           FontSize="11"
                                                           Foreground="{StaticResource TextTertiary}"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver"
                                                         Value="True">
                                                    <Setter TargetName="bg"
                                                            Property="Background"
                                                            Value="{StaticResource CardBackground}"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Button.Template>
                                </Button>

                                <Button Command="{Binding ZoomInCommand}"
                                        ToolTip="Zoom in"
                                        Cursor="Hand">
                                    <Button.Template>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="bg"
                                                    Width="28"
                                                    Height="28"
                                                    CornerRadius="4"
                                                    Background="Transparent">
                                                <TextBlock Text="&#xE710;"
                                                           FontFamily="Segoe MDL2 Assets"
                                                           FontSize="12"
                                                           Foreground="{StaticResource TextTertiary}"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver"
                                                         Value="True">
                                                    <Setter TargetName="bg"
                                                            Property="Background"
                                                            Value="{StaticResource CardBackground}"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Button.Template>
                                </Button>
                            </StackPanel>
                        </Border>
                    </Grid>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</local:WidgetWindowBase>