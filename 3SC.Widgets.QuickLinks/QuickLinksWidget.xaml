<local:WidgetWindowBase x:Class="_3SC.Widgets.QuickLinksWidget"
                        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                        xmlns:local="clr-namespace:_3SC.Widgets"
                        xmlns:vm="clr-namespace:_3SC.ViewModels"
                        Title="Quick Links"
                        Width="300"
                        Height="250"
                        WindowStyle="None"
                        AllowsTransparency="True"
                        Background="Transparent"
                        ShowInTaskbar="False"
                        Topmost="False"
                        ResizeMode="NoResize">

    <local:WidgetWindowBase.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </local:WidgetWindowBase.Resources>

    <Grid Margin="6">
        <Border x:Name="RootBorder"
                Background="{DynamicResource Brushes.WidgetSurface}"
                CornerRadius="18"
                PreviewMouseLeftButtonDown="Border_PreviewMouseLeftButtonDown"
                PreviewMouseMove="Border_PreviewMouseMove"
                PreviewMouseLeftButtonUp="Border_PreviewMouseLeftButtonUp">
            <Border.ContextMenu>
                <ContextMenu>
                    <MenuItem x:Name="LockWidgetMenuItem"
                              Header="Lock Widget"
                              Click="LockWidget_Click"
                              IsCheckable="True"/>
                    <MenuItem x:Name="ResizeToggleMenuItem"
                              Header="Resize Handles"
                              Click="ResizeToggle_Click"
                              IsCheckable="True"/>
                    <Separator/>
                    <MenuItem Header="Remove Widget"
                              Click="RemoveWidget_Click"/>
                </ContextMenu>
            </Border.ContextMenu>

            <Grid>
                <Rectangle x:Name="ResizeOutline"
                           Stroke="{DynamicResource Brushes.WidgetOutline}"
                           StrokeThickness="2"
                           RadiusX="18"
                           RadiusY="18"
                           Visibility="Collapsed"/>

                <Thumb x:Name="ResizeTop"
                       Width="14"
                       Height="14"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Top"
                       Cursor="SizeNS"
                       DragDelta="ResizeTop_DragDelta"
                       Visibility="Collapsed"
                       Margin="0,-7,0,0"
                       Panel.ZIndex="10">
                    <Thumb.Template>
                        <ControlTemplate TargetType="Thumb">
                            <Border Background="{DynamicResource Brushes.WidgetOutline}"
                                    CornerRadius="7"/>
                        </ControlTemplate>
                    </Thumb.Template>
                </Thumb>
                <Thumb x:Name="ResizeBottom"
                       Width="14"
                       Height="14"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Bottom"
                       Cursor="SizeNS"
                       DragDelta="ResizeBottom_DragDelta"
                       Visibility="Collapsed"
                       Margin="0,0,0,-7"
                       Panel.ZIndex="10">
                    <Thumb.Template>
                        <ControlTemplate TargetType="Thumb">
                            <Border Background="{DynamicResource Brushes.WidgetOutline}"
                                    CornerRadius="7"/>
                        </ControlTemplate>
                    </Thumb.Template>
                </Thumb>
                <Thumb x:Name="ResizeLeft"
                       Width="14"
                       Height="14"
                       HorizontalAlignment="Left"
                       VerticalAlignment="Center"
                       Cursor="SizeWE"
                       DragDelta="ResizeLeft_DragDelta"
                       Visibility="Collapsed"
                       Margin="-7,0,0,0"
                       Panel.ZIndex="10">
                    <Thumb.Template>
                        <ControlTemplate TargetType="Thumb">
                            <Border Background="{DynamicResource Brushes.WidgetOutline}"
                                    CornerRadius="7"/>
                        </ControlTemplate>
                    </Thumb.Template>
                </Thumb>
                <Thumb x:Name="ResizeRight"
                       Width="14"
                       Height="14"
                       HorizontalAlignment="Right"
                       VerticalAlignment="Center"
                       Cursor="SizeWE"
                       DragDelta="ResizeRight_DragDelta"
                       Visibility="Collapsed"
                       Margin="0,0,-7,0"
                       Panel.ZIndex="10">
                    <Thumb.Template>
                        <ControlTemplate TargetType="Thumb">
                            <Border Background="{DynamicResource Brushes.WidgetOutline}"
                                    CornerRadius="7"/>
                        </ControlTemplate>
                    </Thumb.Template>
                </Thumb>

                <ContentControl Content="{Binding}">
                    <ContentControl.ContentTemplate>
                        <DataTemplate DataType="{x:Type vm:QuickLinksWidgetViewModel}">
                            <!-- Inlined QuickLinks view -->
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <Border Grid.Row="0"
                                        Background="Transparent"
                                        Padding="20,8"
                                        Cursor="SizeAll">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <TextBlock Grid.Column="0"
                                                   Text="Quick Links"
                                                   FontSize="12"
                                                   FontWeight="SemiBold"
                                                   Foreground="{DynamicResource Brushes.TextPrimary}"
                                                   VerticalAlignment="Center"/>

                                        <TextBlock Grid.Column="1"
                                                   FontSize="10"
                                                   Foreground="{DynamicResource Brushes.TextTertiary}"
                                                   VerticalAlignment="Center">
                                            <Run Text="{Binding Links.Count, Mode=OneWay}"/>
                                            <Run Text="links"/>
                                        </TextBlock>
                                    </Grid>
                                </Border>

                                <Border Grid.Row="0"
                                        VerticalAlignment="Bottom"
                                        Height="1"
                                        Margin="8,0"
                                        Background="{DynamicResource Brushes.CardBorder}"
                                        Opacity="0.25"/>

                                <ScrollViewer Grid.Row="1"
                                              VerticalScrollBarVisibility="Auto"
                                              Padding="14,8,14,8">
                                    <ItemsControl ItemsSource="{Binding Links}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Margin="0,0,0,8"
                                                        Padding="10,8"
                                                        Background="{DynamicResource Brushes.CardBackground}"
                                                        BorderBrush="{DynamicResource Brushes.CardBorder}"
                                                        BorderThickness="1"
                                                        CornerRadius="4">
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                        </Grid.ColumnDefinitions>

                                                        <StackPanel Grid.Column="0"
                                                                    VerticalAlignment="Center">
                                                            <TextBlock Text="{Binding Name}"
                                                                       FontSize="12"
                                                                       FontWeight="Medium"
                                                                       Foreground="{DynamicResource Brushes.TextPrimary}"/>
                                                            <TextBlock Text="{Binding Url}"
                                                                       FontSize="10"
                                                                       Foreground="{DynamicResource Brushes.TextTertiary}"
                                                                       TextTrimming="CharacterEllipsis"/>
                                                        </StackPanel>

                                                        <Button Grid.Column="1"
                                                                Width="28"
                                                                Height="28"
                                                                Margin="8,0,0,0"
                                                                Background="Transparent"
                                                                BorderThickness="0"
                                                                Cursor="Hand"
                                                                ToolTip="Open link"
                                                                Command="{Binding DataContext.OpenLinkCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                CommandParameter="{Binding}">
                                                            <TextBlock Text="&#xE8A7;"
                                                                       FontFamily="Segoe MDL2 Assets"
                                                                       FontSize="14"
                                                                       Foreground="{DynamicResource Brushes.TextPrimary}"/>
                                                        </Button>

                                                        <Button Grid.Column="2"
                                                                Width="28"
                                                                Height="28"
                                                                Margin="4,0,0,0"
                                                                Background="Transparent"
                                                                BorderThickness="0"
                                                                Cursor="Hand"
                                                                ToolTip="Copy link"
                                                                Command="{Binding DataContext.CopyLinkCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                CommandParameter="{Binding}">
                                                            <TextBlock Text="&#xE8C8;"
                                                                       FontFamily="Segoe MDL2 Assets"
                                                                       FontSize="14"
                                                                       Foreground="{DynamicResource Brushes.TextPrimary}"/>
                                                        </Button>

                                                        <Button Grid.Column="3"
                                                                Width="28"
                                                                Height="28"
                                                                Margin="4,0,0,0"
                                                                Background="Transparent"
                                                                BorderThickness="0"
                                                                Cursor="Hand"
                                                                ToolTip="Remove link"
                                                                Command="{Binding DataContext.RemoveLinkCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                CommandParameter="{Binding}">
                                                            <TextBlock Text="&#xE74D;"
                                                                       FontFamily="Segoe MDL2 Assets"
                                                                       FontSize="14"
                                                                       Foreground="#FF4444"/>
                                                        </Button>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>

                                <Border Grid.Row="2"
                                        BorderBrush="{DynamicResource Brushes.CardBorder}"
                                        BorderThickness="0,1,0,0"
                                        Padding="14,12"
                                        Background="{DynamicResource Brushes.CardBackground}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <Border Grid.Column="0"
                                                Background="{DynamicResource Brushes.InputBackground}"
                                                BorderBrush="{DynamicResource Brushes.InputBorder}"
                                                BorderThickness="1"
                                                CornerRadius="4"
                                                Padding="10,6">
                                            <Grid>
                                                <TextBox Text="{Binding NewLinkUrl, UpdateSourceTrigger=PropertyChanged}"
                                                         Background="Transparent"
                                                         BorderThickness="0"
                                                         FontSize="12"
                                                         Foreground="{DynamicResource Brushes.TextPrimary}"
                                                         CaretBrush="{DynamicResource Brushes.Accent}">
                                                    <TextBox.InputBindings>
                                                        <KeyBinding Key="Return"
                                                                    Command="{Binding AddLinkCommand}"/>
                                                    </TextBox.InputBindings>
                                                    <TextBox.Style>
                                                        <Style TargetType="TextBox">
                                                            <Setter Property="FocusVisualStyle"
                                                                    Value="{x:Null}"/>
                                                        </Style>
                                                    </TextBox.Style>
                                                </TextBox>

                                                <TextBlock Text="Enter URL..."
                                                           FontSize="12"
                                                           Foreground="{DynamicResource Brushes.TextTertiary}"
                                                           FontStyle="Italic"
                                                           IsHitTestVisible="False"
                                                           VerticalAlignment="Center"
                                                           Margin="2,0">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="Visibility"
                                                                    Value="Collapsed"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding NewLinkUrl}"
                                                                             Value="">
                                                                    <Setter Property="Visibility"
                                                                            Value="Visible"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                            </Grid>
                                        </Border>

                                        <Button Grid.Column="1"
                                                Width="32"
                                                Height="32"
                                                Margin="8,0,0,0"
                                                Background="{DynamicResource Brushes.Accent}"
                                                BorderThickness="0"
                                                Cursor="Hand"
                                                Command="{Binding AddLinkCommand}">
                                            <TextBlock Text="&#xE710;"
                                                       FontFamily="Segoe MDL2 Assets"
                                                       FontSize="14"
                                                       Foreground="White"/>
                                        </Button>
                                    </Grid>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </ContentControl.ContentTemplate>
                </ContentControl>
            </Grid>
        </Border>
    </Grid>
</local:WidgetWindowBase>
